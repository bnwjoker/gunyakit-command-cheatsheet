# Network Forensics

## Table of Contents

- [tshark](#tshark)
  - [Basic Usage](#basic-usage)
  - [Display Filters](#display-filters)
  - [Field Extraction](#field-extraction)
  - [WLAN Analysis](#wlan-analysis)
  - [DNS Analysis](#dns-analysis)
  - [HTTP Analysis](#http-analysis)
  - [TLS Decryption](#tls-decryption)
  - [Data Exfiltration Detection](#data-exfiltration-detection)
- [Wireshark](#wireshark)
  - [Common Filters](#common-filters)
  - [Statistics](#statistics)
- [tcpdump](#tcpdump)
  - [Capture Traffic](#capture-traffic)
  - [Read PCAP](#read-pcap)

---

## tshark

> Command-line version of Wireshark

### Basic Usage

```shell
# Read PCAP file
tshark -r capture.pcap

# Read with specific filter
tshark -r capture.pcap -Y 'http'

# Capture live traffic
tshark -i eth0

# Capture and save
tshark -i eth0 -w capture.pcap
```

### Display Filters

```shell
# Filter by protocol
tshark -r file.pcap -Y 'http'
tshark -r file.pcap -Y 'dns'
tshark -r file.pcap -Y 'tcp'
tshark -r file.pcap -Y 'icmp'

# Filter by IP
tshark -r file.pcap -Y 'ip.src==192.168.1.1'
tshark -r file.pcap -Y 'ip.dst==192.168.1.1'
tshark -r file.pcap -Y 'ip.addr==192.168.1.1'

# Filter by port
tshark -r file.pcap -Y 'tcp.port==80'
tshark -r file.pcap -Y 'tcp.dstport==443'

# Combined filters
tshark -r file.pcap -Y 'http && ip.src==192.168.1.1'
tshark -r file.pcap -Y 'dns || icmp'
tshark -r file.pcap -Y 'tcp.port==80 && http.request'
```

### Field Extraction

```shell
# Extract specific fields
tshark -r file.pcap -T fields -e ip.src -e ip.dst

# Extract HTTP user-agent
tshark -r file.pcap -Y 'http' -T fields -e http.user_agent

# Extract DNS queries
tshark -r file.pcap -Y 'dns' -T fields -e dns.qry.name

# Extract with separator
tshark -r file.pcap -T fields -E separator=',' -e ip.src -e ip.dst -e tcp.port

# Multiple fields
tshark -r file.pcap -Y 'http.request' -T fields \
  -e ip.src -e http.host -e http.request.uri
```

### WLAN Analysis

```shell
# All WLAN traffic
tshark -r file.pcap -Y 'wlan'

# Beacon frames (SSID broadcast)
tshark -r file.pcap -Y 'wlan.fc.type_subtype==8' -T fields -e wlan.ssid -e wlan.bssid

# Deauthentication frames (potential attack)
tshark -r file.pcap -Y 'wlan.fc.type_subtype==0x000c'
tshark -r file.pcap -Y 'wlan.fc.type_subtype==0x000c' -T fields -e wlan.ra

# EAPOL (WPA handshake)
tshark -r file.pcap -Y 'eapol'

# Find BSSID for specific SSID
tshark -r file.pcap -Y 'wlan.ssid==TargetNetwork' -T fields -e wlan.bssid

# Find channel for SSID
tshark -r file.pcap -Y 'wlan.ssid==TargetNetwork' -T fields -e wlan_radio.channel

# Extract user-agent from specific MAC
tshark -r file.pcap -Y 'wlan.ta==00:11:22:33:44:55 && http' -T fields -e http.user_agent
```

### DNS Analysis

```shell
# All DNS queries
tshark -r file.pcap -Y 'dns' -T fields -e dns.qry.name

# DNS from specific source
tshark -r file.pcap -Y 'dns && ip.src==192.168.1.100' -T fields -e dns.qry.name

# Filter DNS to specific domain
tshark -r file.pcap -Y 'dns.qry.name contains "evil.com"' -T fields -e dns.qry.name

# Unique DNS queries
tshark -r file.pcap -Y 'dns' -T fields -e dns.qry.name | sort | uniq

# DNS tunnel detection
tshark -r file.pcap -Y 'dns && ip.dst==18.217.1.57' -T fields -e dns.qry.name | \
  awk -F . '{print $1}' | tr -d '\n' | base64 -d

# DNS exfiltration detection
tshark -r file.pcap -Y 'dns && ip.src==192.168.1.100' -T fields -e dns.qry.name | \
  grep -i 'oast.me\|burpcollaborator\|dnslog' | uniq
```

### HTTP Analysis

```shell
# HTTP requests only
tshark -r file.pcap -Y 'http.request'

# HTTP responses only  
tshark -r file.pcap -Y 'http.response'

# Extract URLs
tshark -r file.pcap -Y 'http.request' -T fields -e http.host -e http.request.uri

# Extract POST data
tshark -r file.pcap -Y 'http.request.method==POST' -T fields -e http.file_data

# Extract form data
tshark -r file.pcap -Y 'http' -T fields -e urlencoded-form.key -e urlencoded-form.value

# Find passwords in HTTP
tshark -r file.pcap -Y 'http' -T fields -e text | grep -i password
```

### TLS Decryption

```shell
# With SSL keylog file (from browser)
tshark -r file.pcap -o tls.keylog_file:./keylog.txt -Y 'http' -T fields -e http.request.uri

# Extract decrypted form data
tshark -r file.pcap -o tls.keylog_file:./keylog.txt -Y 'http' -T fields -e urlencoded-form.value
```

### Data Exfiltration Detection

```shell
# ICMP tunnel (TTL exfiltration)
tshark -r file.pcap -Y 'icmp.resp_to' -T fields -e ip.ttl | tr -d '\n'

# Endpoints analysis
tshark -n -r file.pcap -z endpoints,ip
tshark -n -r file.pcap -z endpoints,ip,"icmp"

# Extract raw data from TCP
tshark -r file.pcap -Y 'tcp' -T fields -e 'data.data' | xxd -r -p

# Decode base64 from TCP data
tshark -r file.pcap -Y 'tcp' -T fields -e 'data.data' | xxd -r -p | \
  grep -oE '[A-Za-z0-9+/=]{20,}' | base64 -d

# Find suspicious long DNS queries
tshark -r file.pcap -Y 'dns' -T fields -e dns.qry.name | \
  awk 'length($0) > 50 {print}'
```

---

## Wireshark

### Common Filters

```text
# Protocol filters
http
dns
tcp
udp
icmp
ftp
ssh
tls

# IP filters
ip.addr == 192.168.1.1
ip.src == 192.168.1.1
ip.dst == 192.168.1.1

# Port filters
tcp.port == 80
tcp.dstport == 443
udp.port == 53

# HTTP specific
http.request
http.response
http.request.method == "POST"
http.request.uri contains "admin"
http.user_agent contains "curl"

# DNS specific
dns.qry.name contains "evil"
dns.flags.response == 0   # Queries only
dns.flags.response == 1   # Responses only

# TCP flags
tcp.flags.syn == 1
tcp.flags.rst == 1
tcp.flags.fin == 1

# Content search
frame contains "password"
tcp contains "secret"
http contains "flag"
```

### Statistics

```text
# Menu: Statistics > Endpoints
# Menu: Statistics > Conversations
# Menu: Statistics > Protocol Hierarchy
# Menu: Statistics > HTTP > Requests
```

---

## tcpdump

### Capture Traffic

```shell
# Capture on interface
tcpdump -i eth0

# Capture with filter
tcpdump -i eth0 port 80
tcpdump -i eth0 host 192.168.1.1
tcpdump -i eth0 'port 80 or port 443'

# Save to file
tcpdump -i eth0 -w capture.pcap

# Capture specific number of packets
tcpdump -i eth0 -c 100 -w capture.pcap

# Verbose output
tcpdump -i eth0 -vvv
```

### Read PCAP

```shell
# Read PCAP file
tcpdump -r capture.pcap

# Read with filter
tcpdump -r capture.pcap host 192.168.1.1

# Show ASCII content
tcpdump -r capture.pcap -A

# Show hex and ASCII
tcpdump -r capture.pcap -X

# Show only headers
tcpdump -r capture.pcap -q
```

---

## See Also

- **[SOC Analysis](11.2.SOC-Analysis.md)** - YARA rules, threat hunting
- **[Port Scanning](../1.Scanning/Port-Scanning.md)** - Network reconnaissance
