# Port 4222 - NATS

## Table of Contents

- [Enumeration](#enumeration)
- [Exploitation](#exploitation)
- [Post Exploitation](#post-exploitation)

---

## Enumeration

### Nmap Scripts

```shell
nmap -sV -sC -p4222 $rhost
```

### Banner Grabbing

```shell
nc -vn $rhost 4222

# NATS returns INFO on connect
# Example: INFO {"server_id":"...","version":"2.x.x",...}
```

### Get Server Info

```shell
# Connect and receive INFO
echo "PING" | nc $rhost 4222

# Using telnet
telnet $rhost 4222
# Server sends INFO automatically
```

### Check Monitoring Port

```shell
# NATS monitoring typically on port 8222
curl http://$rhost:8222/
curl http://$rhost:8222/varz
curl http://$rhost:8222/connz
curl http://$rhost:8222/routez
curl http://$rhost:8222/subsz
```

---

## Exploitation

### Anonymous Access

```shell
# NATS may allow anonymous connections
# Test by connecting and subscribing

# Using nats CLI
nats sub ">" --server=$rhost:4222

# Using natscli
nats-sub -s nats://$rhost:4222 ">"
```

### Subscribe to All Messages

```shell
# Install NATS CLI
go install github.com/nats-io/natscli/nats@latest

# Subscribe to all subjects (wildcard)
nats sub ">" -s nats://$rhost:4222

# Subscribe to specific pattern
nats sub "orders.*" -s nats://$rhost:4222
nats sub "*.events.>" -s nats://$rhost:4222
```

### Publish Messages

```shell
# Publish message
nats pub "test.subject" "Hello World" -s nats://$rhost:4222

# Publish with reply subject
nats pub "orders.create" '{"item":"test"}' -s nats://$rhost:4222
```

### Request-Reply

```shell
# Make a request
nats request "api.orders" '{"action":"list"}' -s nats://$rhost:4222
```

---

## Post Exploitation

### Enumerate Subjects

```shell
# Subscribe to wildcard and observe traffic
nats sub ">" -s nats://$rhost:4222 | tee nats_traffic.log

# Common subject patterns
# api.*
# events.*
# orders.*
# users.*
# notifications.*
```

### JetStream (Persistent Messaging)

```shell
# If JetStream is enabled
nats stream ls -s nats://$rhost:4222
nats stream info STREAM_NAME -s nats://$rhost:4222
nats consumer ls STREAM_NAME -s nats://$rhost:4222

# Read from stream
nats consumer next STREAM_NAME CONSUMER_NAME -s nats://$rhost:4222
```

### Account Information

```shell
# Get connection info
nats server info -s nats://$rhost:4222

# Check accounts (if monitoring enabled)
curl http://$rhost:8222/accountz
```

### Python Client

```python
#!/usr/bin/env python3
import asyncio
import nats

async def main():
    nc = await nats.connect("nats://$rhost:4222")
    
    # Subscribe to all
    async def message_handler(msg):
        print(f"Subject: {msg.subject}")
        print(f"Data: {msg.data.decode()}")
    
    await nc.subscribe(">", cb=message_handler)
    
    # Keep running
    await asyncio.sleep(3600)

asyncio.run(main())
```

---

## NATS Ports

| Port | Service |
|------|---------|
| 4222 | Client connections |
| 6222 | Cluster routing |
| 8222 | HTTP monitoring |
| 4223 | TLS client connections |

---

## Tools

- NATS CLI: https://github.com/nats-io/natscli
- nats.py: https://github.com/nats-io/nats.py
- nats.go: https://github.com/nats-io/nats.go

---

## References

- [HackTricks - NATS](https://book.hacktricks.wiki/network-services-pentesting/4222-pentesting-nats.html)
- [NATS Documentation](https://docs.nats.io/)
